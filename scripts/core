#!/usr/bin/env bash

# Source base functions
source "$(dirname "${BASH_SOURCE[0]}")/base"

DIRECTORY="$HOME/Akeptous/qumran/.qumran"
[[ -e "/opt/homebrew/bin/limactl" ]] && VM_LIST="$(limactl list)"

setup() {
    [[ ! -d "$DIRECTORY" ]] && mkdir -p "$DIRECTORY"
    [[ "$VM_LIST" != *"qumran"* ]] && limactl create --name="qumran"
}

start() {
    if [[ "$VM_LIST" == *"qumran"* && "$VM_LIST" != *"qumran"*"Running"* ]]; then
        limactl start qumran
        limactl shell qumran
    fi
}

stop() {
    if [[ "$VM_LIST" == *"qumran"*"Running"* ]]; then
        limactl stop qumran
        [[ -d "$DIRECTORY" ]] && rm -rf "$DIRECTORY"
    fi
}

destroy() {
    [[ -d "$DIRECTORY" ]] && rm -rf "$DIRECTORY"

    if [[ "$VM_LIST" == *"qumran"* && "$VM_LIST" == *"qumran"*"Running"* ]]; then
        limactl stop qumran
        limactl delete qumran
        exit 0
    fi

    [[ "$VM_LIST" == *"qumran"* ]] && limactl delete qumran
}

ping() {
    if [[ "$VM_LIST" != *"qumran"*"Running"* ]]; then
        log_warn "Qumran VM is not running. Please run 'workspace start' first."
        return 1
    fi

    log_info "Installing/updating Ansible and running ping test inside Qumran VM."
    limactl shell qumran bash <<'EOF'
set -e
echo "INFO: Updating package list..."
sudo apt-get update -y -qq
echo "INFO: Installing software-properties-common..."
sudo apt-get install -y -qq software-properties-common
echo "INFO: Adding Ansible PPA..."
sudo add-apt-repository --yes --update ppa:ansible/ansible
echo "INFO: Installing Ansible..."
sudo apt-get install -y -qq ansible
echo "INFO: Running ansible ping..."
ansible localhost -m ping
EOF
}

execute_destroy() {
    log_info "Destroying Qumran VM"
    destroy
}

execute_ping() {
    log_info "Checking Ansible status on Qumran VM"
    ping
}

execute_setup() {
    log_info "Setting-up Qumran VM"
    setup
}

execute_start() {
    log_info "Starting Qumran VM"
    start
}

execute_stop() {
    log_info "Stopping Qumran VM"
    stop
}

execute_provision() {
    log_info "Provisioning Qumran VM"
}
