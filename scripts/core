#!/usr/bin/env bash

# Source base functions
source "$(dirname "${BASH_SOURCE[0]}")/base"

USERNAME="qumran_user"
PLAYBOOK="development.yml"
DIRECTORY="$HOME/Akeptous/qumran/.qumran"
PODMAN_MACHINE_LIST="$(podman machine list)"

setup() {
    [[ ! -d "$DIRECTORY" ]] && mkdir -p "$DIRECTORY"

    [[ "$PODMAN_MACHINE_LIST" != *"qumran"* ]] &&
        podman machine init \
            --username="$USERNAME" \
            --playbook="$PLAYBOOK" qumran \
            --volume="$DIRECTORY:/usr/share/rpm:rw"
}

start() {
    if [[ "$PODMAN_MACHINE_LIST" == *"qumran"* && "$PODMAN_MACHINE_LIST" != *"qumran*"*"Currently running"* ]]; then
        podman machine start qumran --no-info
        podman machine ssh qumran "ansible-playbook playbook.yaml"
    fi
}

stop() {
    if [[ "$PODMAN_MACHINE_LIST" == *"qumran*"*"Currently running"* ]]; then
        podman machine stop qumran
        [[ -d "$DIRECTORY" ]] && rm -rf "$DIRECTORY"
    fi
}

destroy() {
    if [[ "$PODMAN_MACHINE_LIST" == *"qumran"* && "$PODMAN_MACHINE_LIST" == *"qumran*"*"Currently running"* ]]; then
        podman machine stop qumran
        podman machine rm qumran
        exit 0
    fi

    [[ "$PODMAN_MACHINE_LIST" == *"qumran"* ]] && podman machine rm qumran
}

execute_destroy() {
    log_info "Destroying local development"
    destroy
}

execute_setup() {
    log_info "Setting-up local development"
    setup
}

execute_start() {
    log_info "Starting local development"
    start
}

execute_stop() {
    log_info "Stopping local development"
    stop
}
