#!/usr/bin/env bash

# Source base functions
source "$(dirname "${BASH_SOURCE[0]}")/base"

DIRECTORY="$HOME/Akeptous/qumran/.qumran"
[[ -e "/opt/homebrew/bin/limactl" ]] && VM_LIST="$(limactl list)"

setup() {
    [[ ! -d "$DIRECTORY" ]] && mkdir -p "$DIRECTORY"

    [[ "$VM_LIST" != *"qumran"* ]] &&
        limactl create --name="qumran"
}

start() {
    if [[ "$VM_LIST" == *"qumran"* && "$VM_LIST" != *"qumran"*"Running"* ]]; then
        limactl start qumran
        limactl shell qumran
    fi
}

stop() {
    if [[ "$VM_LIST" == *"qumran"*"Running"* ]]; then
        limactl stop qumran
        [[ -d "$DIRECTORY" ]] && rm -rf "$DIRECTORY"
    fi
}

destroy() {
    [[ -d "$DIRECTORY" ]] && rm -rf "$DIRECTORY"

    if [[ "$VM_LIST" == *"qumran"* && "$VM_LIST" == *"qumran"*"Running"* ]]; then
        limactl stop qumran
        limactl delete qumran
        exit 0
    fi

    [[ "$VM_LIST" == *"qumran"* ]] && limactl delete qumran
}

execute_destroy() {
    log_info "Destroying local development"
    destroy
}

execute_setup() {
    log_info "Setting-up local development"
    setup
}

execute_start() {
    log_info "Starting local development"
    start
}

execute_stop() {
    log_info "Stopping local development"
    stop
}
